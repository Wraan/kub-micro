## Description:
Right now this project has only 2 modules:
* Link-shortener service which as its name says shortens long links and generates shorter ones. It also stores information about the shortened link (creator username, times used, date of creation, date when it expires). Service is secured, anonymous users will be able to generate link and access it, but they will not be able to get detailed informations, delete them, refresh them etc. Service is using JWT tokens created by auth server in order to authenticate users.
* Auth-server - server which is used to authorise requests based on OAuth2 JWT tokens. It also stores information about clients and users which will be used in all services inside that project.
* More will come


All these services are configured to work with kubernetes using local minikube instance. All necessary resources to run them are available inside kubernetes folder. You can run the services locally on your machine, but you will need to change the configuration inside application.properties files.


## Configuration to run it locally:
* Link-shortener:
```
ingress.service.path=/link                                                      # locally it has to be empty
spring.data.mongodb.uri=mongodb://wran:password@192.168.137.226:31955/admin     # change to your database
feign.client.auth-server.url=http://localhost:8801                              # url to your auth-server service used by feign client
security.oauth2.client.access-token-uri=http://localhost:8801/oauth/token       # url to your endpoint on auth-server service
security.oauth2.client.client-id=link-shortener                                 # credentials to your service client
security.oauth2.client.client-secret=password
```

* Auth-service:

```
spring.datasource.url=jdbc:postgresql://192.168.137.226:32417/authdb            #here you just change the credentials to your database
spring.datasource.username=admin
spring.datasource.password=password
```

## Configuration to work it inside minikube:

Services inside the minikube cluster should work with default values. You can just pull the images from dockerhub and run these on pods.

### Procedure to run it in minikube cluster:

1) First you have to create your databases:
```
Kubectl apply -f psql-cm-secret.yaml psql-pv-pcv.yaml psql-deploy-service.yaml
Kubectl apply -f mongoldb-cm-sec.yaml mongodb-pv-pvc.yaml mongodb-deploy.yaml
```

2) Then you can run your services
```
Kubectl apply -f auth-server-deploy.yaml
Kubectl apply -f link-shortener-deploy.yaml
```

Services are configured in a way that you can access them from your host without a need to port-forward to the created pods and without using ingress (services are set to be NodePorts).


Deployments are configured in a way that they will download Docker images from my public docker hub. In order to run the pod with docker images from you local machine you will need to change the deployments:
```
image: <image_name>
imagePullPolicy: Never
```

In order to build your images inside minikube you have to execute following command:
MAC: `eval $(minikube docker-env)`
Windows: `minikube docker-env` and execute command that appeared in the comment after

Now when you build images with docker they will be stored inside your miinikube VM.

3) You will need to get the miinikube IP
```
minikube ip
```
And ports of your services
```
Kubectl get services
```

4)Then you will be able to access your services e.g. `192.168.10.125:31456/oauth/token` where the 31456 is the auth-server port from your services.


5*) You can use Ingress in order to access the services without using NodePort type services. You will have to change the `ingress.service.path` property in the link-shortener ConfigMap accordingly to the declared inside the Ingress path. Default declared ingress path to link-shortener service is `/link`.

After these actions you should be able to access these services.

## How does it work:

### Authorization:

Services are partially secured with a JWT token generated by our OAuth2 auth-server. In order to get to secured endpoints you will need to generate a token. By default there are 2 users created and one client.
Users: admin/password, test/password
Client: link-shortener/password

You have 2 ways to generate the token:

1) Generating it from the auth-server directly.
You will have to add parameters to your POST request to the `auth-server/oauth/token`
```
grant_type: password
username: <username e.g. admin>
password: <password e.g. password>
```
And set the authorization to Basic Auth using the client credentials e.g link-shortener/password


2) Login with link-shortener service which will return you the token by login as the link-shortener client.
You will have to add parameters to your POST request to the link-shortener/login which have to be ENCODED with Base64
```
username: <username e.g. admin is YWRtaW4= >
password: <password e.g. password is cGFzc3dvcmQ= >
```

After you get the token generated you can access all the endpoints in the link-shortener service using the Authentication header with value set to “bearer <token>”
E.g.
```
Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsibGlua3MiXSwidXNlcl9uYW1lIjoid3JhbnRlc3QiLCJzY29wZSI6WyJSRUFEIiwiV1JJVEUiXSwiZXhwIjoxNTY1MzUwODE0LCJqdGkiOiI3ZWFiNjQ1Ny02ZDRiLTQyZWQtYjYwNS0xZDFjN2M0ZDkzZjUiLCJlbWFpbCI6IndyYW5AZ21haWwuY29tIiwiY2xpZW50X2lkIjoibGluay1zaG9ydGVuZXIifQ.CWtz-iKXXHr2vLzw2fbX9sFD2LNj_kxEqY_pk2x34FM
```

### Link-shortener service

[S] - secured endpoints which can be accessed only with authorization token.

Service has few endpoints which can be used:
* `     POST /api/ `  - endpoint which shortens links. In the body there has to be send JSON which will define the long linka and it's liveness in minutes. Eg.:
```
{
"link": "https://www.google.pl/",
"liveness": 10
}
```
* ` [S] GET /api/ ` - listens all generated short links
* ` [S] GET /api/{shortLink} ` - gives more information about generated link
* ` [S] DELETE /api/{shortLink} ` - deletes generated link
* ` [S] GET /api/testData ` - created for testing purposes, it creates 10000 test links to the same link with different liveness
* ` [S] GET /api/cleanExpired ` - creates multithreaded task which cleans database from expired short links.
* `     GET /{shortLink} ` redirects you to site refered by your short link
* `     GET /expired /not-found /disabled ` error pages
* ` [S] GET /secured/extras ` - gives more information about the user
* `     POST /login ` instead of using auth-server you can generate token using this endpoint which will use link-shortener client. It requires username and password parameters which has to be Base64 encoded.
* `     POST /register ` you can register new user in your auth-server database. In the body there has to be send JSON with the user credentials and mail. Credentials have to be Base64 encoded. Eg.:
```
{
	"username": "d3JhbnRlc3Q=", # wrantest
	"password": "cGFzc3dvcmQ=", # password
	"email": "wran@gmail.com"
}
```
